name: Build PNIDGrab for Windows

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  windows-zip:
    name: Package as a ZIP Archive
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          path-type: inherit
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-pkg-config
            mingw-w64-x86_64-gtk4
            mingw-w64-x86_64-libadwaita
      - name: Build
        shell: msys2 {0}
        run: |
          rustup toolchain install stable-x86_64-pc-windows-gnu
          rustup default stable-x86_64-pc-windows-gnu
          cargo build --release --target x86_64-pc-windows-gnu
      - name: Collect DLLs
        shell: msys2 {0}
        run: |
          dist_dir="dist/windows"
          exe="target/x86_64-pc-windows-gnu/release/pnidgrab.exe"
          mkdir -p "$dist_dir"
          cp "$exe" "$dist_dir/"
          ldd "$exe" | awk '/mingw64.*\.dll/ {print $3}' | while read -r dll; do
            if [ -f "$dll" ]; then
              cp "$dll" "$dist_dir/"
            fi
          done
      - name: Package Zip
        shell: pwsh
        run: |
          $out = "dist/windows"
          Compress-Archive -Path "$out/*" -DestinationPath "PNIDGrab-windows.zip" -Force
      - name: Upload Zip
        uses: actions/upload-artifact@v4
        with:
          name: pnidgrab-windows-zip
          path: PNIDGrab-windows.zip
